<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini CAMS - Pronóstico Contaminantes</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body { font-family: Arial, sans-serif; margin: 20px; position: relative; }
  #mapContainer { max-width: 700px; }
  #map { width: 100%; height: 450px; margin-bottom: 5px; }
  #sliderHora { width: 100%; margin: 5px 0; }
  #info { margin-top: 10px; font-weight: bold; }
  .legend { margin-top: 10px; }
  select, button { margin: 5px; }
  #chartContainer {
    width: 400px;
    height: 400px;
    position: absolute;  
    top: 120px;            
    left: 720px;          
    z-index: 1000;        
    background-color: white; 
    border: 1px solid #ccc;  
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
  }
</style>
</head>
<body>

<h2>Mini CAMS - Pronóstico de Contaminantes</h2>

<label for="region">Selecciona Región:</label>
<select id="region">
  <option value="europa">Europeo</option>
  <option value="global">Global</option>
</select>

<label for="contaminante">Selecciona Contaminante:</label>
<select id="contaminante"></select>

<div class="legend" id="leyenda">Leyenda: --- </div>

<!-- Contenedor del mapa y slider -->
<div id="mapContainer">
  <div id="map">Cargando mapa...</div>
  <label for="sliderHora">Hora (pronóstico): <span id="horaLabel">0</span></label><br />
  <input type="range" id="sliderHora" min="0" max="23" value="0" list="tickmarks"/>
  <datalist id="tickmarks"></datalist>
</div>

<br/>
<button id="btnAnimar">Play</button>

<div id="info">Haz clic en el mapa para ver el valor aquí.</div>

<div id="chartContainer"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>

<script>
  // Contaminantes y leyendas
  const contaminantesPorRegion = {
    europa: ['NO2 EU','O3 EU','PM2.5 EU','PM10 EU','SO2 EU','CO EU','DUST EU','NH3 EU'],
    global: ['CO','SO2','PM10','PM2.5','NO2','O3','CH4','CO2','UV INDEX']
  };

  const leyendas = {
    'PM2.5': 'Partículas finas (PM2.5) en μg/m³',
    'PM10': 'Partículas (PM10) en μg/m³',
    'NO2': 'Dióxido de nitrógeno (NO2) en μg/m³',
    'SO2': 'Dióxido de azufre (SO2) en μg/m³',
    'CH4': 'Metano (CH4) en μg/m³',
    'O3': 'Ozono (O3) en μg/m³',
    'CO': 'Monóxido de carbono (CO) en μg/m³',
    'CO2': 'Dióxido de carbono (CO2) en μg/m³',
    'UV INDEX': 'Índice Ultravioleta (adimensional)',
    'PM10 EU': 'Partículas (PM10) en Europa μg/m³',
    'NO2 EU': 'Dióxido de nitrógeno (NO2) en Europa μg/m³',
    'SO2 EU': 'Dióxido de azufre (SO2) en Europa μg/m³',
    'O3 EU': 'Ozono (O3) en Europa μg/m³',
    'CO EU': 'Monóxido de carbono (CO) en Europa μg/m³',
    'PM2.5 EU': 'Partículas finas (PM2.5) en Europa μg/m³',
    'DUST EU': 'Polvo (DUST) en Europa μg/m³',
    'NH3 EU': 'Amoníaco (NH3) en Europa μg/m³'
  };

  const wmsInfo = {
    europa: {
      url: 'https://eccharts.ecmwf.int/wms/?token=public',
      layers: {
        'NO2 EU':'composition_europe_no2_forecast_surface',
        'O3 EU':'composition_europe_o3_forecast_surface',
        'PM2.5 EU':'composition_europe_pm2p5_forecast_surface',
        'PM10 EU':'composition_europe_pm10_forecast_surface',
        'SO2 EU':'composition_europe_so2_forecast_surface',
        'CO EU':'composition_europe_co_forecast_surface',
        'DUST EU':'composition_europe_dust_forecast_surface',
        'NH3 EU':'composition_europe_nh3_forecast_surface'
      }
    },
    global: {
      url: 'https://eccharts.ecmwf.int/wms/?token=public',
      layers: {
        'CO':'composition_co_surface',
        'SO2':'composition_so2_surface',
        'PM10':'composition_pm10',
        'PM2.5':'composition_pm2p5',
        'NO2':'composition_no2_surface',
        'O3':'composition_o3_surface',
        'CH4':'composition_ch4_surface',
        'CO2':'composition_co2_surface',
        'UV INDEX':'composition_uvindex'
      }
    }
  };

  function getLayerStyleByType(name){
    const styleMap={
      'PM2.5 EU':'sh_pm2p5_surface_concentration','PM10 EU':'sh_pm10_surface_concentration',
      'NO2 EU':'sh_no2_surface_concentration','O3 EU':'sh_o3_surface_concentration',
      'SO2 EU':'sh_so2_surface_concentration','CO EU':'sh_co_surface_concentration',
      'DUST EU':'sh_dust_web_surface_concentration','NH3 EU':'sh_nh3_surface_concentration',
      'CO':'sh_co_surface_concentration','SO2':'sh_so2_surface_concentration',
      'PM10':'sh_pm10_surface_concentration','PM2.5':'sh_pm2p5_surface_concentration',
      'NO2':'sh_no2_surface_concentration','O3':'sh_o3_surface_concentration',
      'CH4':'sh_ch4_surface_concentration','CO2':'sh_co2_surface_concentration',
      'UV INDEX':'sh_all_uvindex'
    };
    return styleMap[name]||'';
  }

  const regionCenters = { europa:[52.52,13.405], global:[20,0] };
  const regionZoom = { europa:5, global:3 };
  const regionSelect = document.getElementById('region');
  const contaminanteSelect = document.getElementById('contaminante');
  const leyendaDiv = document.getElementById('leyenda');
  const infoDiv = document.getElementById('info');
  const sliderHora = document.getElementById('sliderHora');
  const horaLabel = document.getElementById('horaLabel');
  const btnAnimar = document.getElementById('btnAnimar');

  const map = L.map('map').setView(regionCenters.europa, regionZoom.europa);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains:'abcd', maxZoom:20
  }).addTo(map);

  let wmsLayer=null;
  const ahora = new Date();
  const diasPronostico = 4;
  const fin = new Date(ahora); fin.setUTCDate(fin.getUTCDate()+diasPronostico); fin.setUTCHours(0,0,0,0);
  const diffMs = fin-ahora;
  const numHoras = Math.floor(diffMs/(1000*60*60));
  const horasDisponibles = Array.from({length:numHoras+1},(_,i)=>{
    const fecha=new Date(ahora); fecha.setUTCHours(fecha.getUTCHours()+i); fecha.setUTCMinutes(0,0,0);
    return fecha.toISOString();
  });

  sliderHora.max=horasDisponibles.length-1;
  const tickmarks=document.getElementById('tickmarks'); tickmarks.innerHTML='';
  let lastDay=null;
  horasDisponibles.forEach((fechaISO,i)=>{
    const fecha=new Date(fechaISO);
    const day=fecha.getUTCDate();
    const weekday=fecha.toLocaleDateString('es-ES',{weekday:'short',day:'numeric'});
    if(day!==lastDay){
      const option=document.createElement('option');
      option.value=i; option.label=weekday;
      tickmarks.appendChild(option);
      lastDay=day;
    }
  });

  function actualizarCapa() {
    const region = regionSelect.value;
    const contaminante = contaminanteSelect.value;
    const horaIndex = parseInt(sliderHora.value);
    if (!contaminante) return;

    if (wmsLayer) map.removeLayer(wmsLayer);

    // fecha real (lo que selecciona el slider)
    const fechaReal = new Date(horasDisponibles[horaIndex]);

    // fecha de petición (redondeada si es global)
    const fechaPeticion = new Date(fechaReal);
    if (region === 'global') {
        const h = getHour3(fechaPeticion.getUTCHours());
        fechaPeticion.setUTCHours(h, 0, 0, 0);
    }

    const timeISO = fechaPeticion.toISOString();
    const wmsUrl = wmsInfo[region].url;
    const layerName = wmsInfo[region].layers[contaminante];
    const styleName = getLayerStyleByType(contaminante);

    wmsLayer = L.tileLayer.wms(wmsUrl, {
        layers: layerName,
        format: 'image/png',
        transparent: true,
        opacity: 0.6,
        time: timeISO,
        attribution: 'CAMS - Copernicus Atmosphere Monitoring Service'
    }).addTo(map);

    if (styleName) {
        wmsLayer.setParams({ styles: styleName });
    }

    // Leyenda → usamos la fecha REAL
    const label = fechaReal.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
    leyendaDiv.textContent = `Leyenda: ${leyendas[contaminante]} (Hora UTC: ${fechaReal.getUTCHours()}:00)`;
    horaLabel.textContent = label;
  }

  function actualizarContaminantes(){
    const region=regionSelect.value;
    contaminanteSelect.innerHTML='';
    contaminantesPorRegion[region].forEach(c=>{
      const opt=document.createElement('option'); opt.value=c; opt.textContent=c;
      contaminanteSelect.appendChild(opt);
    });
    map.setView(regionCenters[region],regionZoom[region]);
    actualizarCapa();
  }

  let animando=false; let animInterval=null;
  btnAnimar.addEventListener('click',()=>{
    if(!animando){
      animando=true; btnAnimar.textContent='Stop';
      animInterval=setInterval(()=>{
        sliderHora.value=(parseInt(sliderHora.value)+1)%horasDisponibles.length;
        actualizarCapa();
      },1000);
    }else{
      animando=false; btnAnimar.textContent='Play'; clearInterval(animInterval);
    }
  });

  sliderHora.addEventListener('input',()=>{ actualizarCapa(); });
  regionSelect.addEventListener('change',actualizarContaminantes);
  contaminanteSelect.addEventListener('change',actualizarCapa);

  map.on('click',async e=>{
    const {lat,lng}=e.latlng;
    const contaminante=contaminanteSelect.value;
    const valorReal=await getValueFromLayer(map,wmsInfo[regionSelect.value].layers[contaminante],e.latlng,horasDisponibles[sliderHora.value]);
    infoDiv.textContent=`Valor en (${lat.toFixed(3)}, ${lng.toFixed(3)}): ${valorReal} μg/m³`;
    const datosHistoricos=await getHistoricalDataForPollutant(e.latlng);
    plotPollutantHistory(datosHistoricos);
  });

  actualizarContaminantes();

  async function getValueFromLayer(map,layer,latlng,date){
    const location=`${latlng.lng},${latlng.lat},${latlng.lng},${latlng.lat}`;
    const url="https://eccharts.ecmwf.int/wms/?token=public&request=GetCapabilities&request=GetFeatureInfo&version=1.3.0&version=1.1.1&service=WMS&layers="+layer
      +"&styles=&format=image/jpeg&transparent=true&tiled=true&time="+date+"&width=1660&height=807&srs=EPSG:4326&bbox="+location+"&query_layers="+layer+"&X=0&Y=0";
    try{
      const response=await fetch(url);
      const text=await response.text();
      let value=text.split("\n")[3]?.replace("Value: ","").split(" ")[0]||null;
      if(value===null||value.includes("ServiceExceptionReport")) value="No disponible";
      return value;
    }catch(e){console.error(e); return null;}
  }

  async function getHistoricalDataForPollutant(latlng){
    const region=regionSelect.value;
    const contaminante=contaminanteSelect.value;
    const layerName=wmsInfo[region].layers[contaminante];
    const dates=horasDisponibles;
    const values=await Promise.all(dates.map(date=>getValueFromLayer(map,layerName,latlng,date)));
    return dates.map((date,i)=>[Date.parse(date),parseFloat(values[i]||0)]);
  }

  function plotPollutantHistory(data){
    Highcharts.chart('chartContainer',{
      chart:{type:'line',zoomType:'x'},
      title:{text:'Historial de Contaminantes'},
      xAxis:{type:'datetime',title:{text:'Fecha/Hora UTC'}},
      yAxis:{title:{text:'Concentración (μg/m³)'},min:0},
      tooltip:{xDateFormat:'%Y-%m-%d %H:%M',pointFormat:'<b>{point.y}</b> μg/m³'},
      series:[{name:contaminanteSelect.value,data:data,turboThreshold:0}],
      credits:{enabled:false}, exporting:{enabled:true}, accessibility:{enabled:false}
    });
  }

  function getHour3(hour) {
    return 3 * Math.floor(hour / 3); // siempre redondea hacia abajo al múltiplo de 3
  }

</script>
</body>
</html>
